import boto3
import pandas as pd
from io import StringIO # python3: python2: BytesIO

#defining all parametrs

AWS_ACCESS_KEY ='AKIAQM5PKG2LN2JKRLHR'
AWS_SECRET_KEY ='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'
AWS_REGION ='ap-south-1'
SCHEMA_NAME ='covid_dataset' # athena database name
S3_STAGING_DIR ='s3://vishnu-test-buck/output/' # query output will stored in output folder
S3_BUCKET_NAME ='vishnu-test-buck'
S3_OUTPUT_DIRECTORY ='output'


# connecting to athena for query

athena_client =boto3.client('athena',
	aws_access_key_id=AWS_ACCESS_KEY,
	aws_secret_access_key=AWS_SECRET_KEY,
	region_name=AWS_RGION,)




#defining function

Dict={}

def download_and_load_query_results(
    client:boto3.client,query_response:Dict
) ->pd.DataFrame:
    while True:
        try:
            # This function only loads the first 1000 rows
            client.get_query_results(
            QueryExecutionId=query_response['QueryExecutionId']

            )
            break
        except Exceptionn as err:
            if 'not yet finished' in str(err):
                time.sleep(0.001)
            else:
                raise err
    temp_file_location:str ='athena_query_results.csv'
    s3_client =boto3.client(
        's3',
        aws_access_key_id=AWS_ACCESS_KEY,
        aws_secret_access_key=AWS_SECRET_KEY,
        region_name=AWS_REGION,
    )

    s3_client.download_file(
        S3_BUCKET_NAME,
        f"{S3_OUTPUT_DIRECTORY}/{query_response['QueryExecutionId']}.csv",
        temp_file_loaction,
    )

    return pd.read_csv(temp_file_location)







#querying athena (table1 -enigma_jhud)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM enigma_jhud",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)



response

df_data=download_and_load_query_results(athena_client,response)

engima_jhud.head()



#querying athena (table2 -nytimes_data_in_usa_countryus_county)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM nytimes_data_in_usa_countryus_county",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


nytimes_data_in_usa_countryus_county=download_and_load_query_results(athena_client,response)


nytimes_data_in_usa_countryus_county.head()




#querying athena (table3 -nytimes_data_in_usa_us_states)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM nytimes_data_in_usa_us_states",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


nytimes_data_in_usa_us_states=download_and_load_query_results(athena_client,response)


nytimes_data_in_usa_us_states.head()


#querying athena (table4 -rearc_covid_19_testing_data_states_daily)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM rearc_covid_19_testing_data_states_daily",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)

rearc_covid_19_testing_data_states_daily=download_and_load_query_results(athena_client,response)

rearc_covid_19_testing_data_states_daily.head()


#querying athena (table5 -rearc_covid_19_testing_data_us_daily)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM rearc_covid_19_testing_data_us_daily",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


rearc_covid_19_testing_data_us_daily=download_and_load_query_results(athena_client,response)

rearc_covid_19_testing_data_us_daily.head()



#querying athena (table6 -rearc_covid_19_testing_data_us_total_latest)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM rearc_covid_19_testing_data_us_total_latest",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


rearc_covid_19_testing_data_us_total_latest=download_and_load_query_results(athena_client,response)

rearc_covid_19_testing_data_us_total_latest.head()


#querying athena (table8 -static_datasets_countrycode)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM static_datasets_countrycode",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


static_datasets_countrycode=download_and_load_query_results(athena_client,response)

static_datasets_countrycode.head()




#querying athena (table9 -static_datasets_countypopulation)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM static_datasets_countypopulation",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


static_datasets_countypopulation=download_and_load_query_results(athena_client,response)

static_datasets_countypopulation.head()

#querying athena (table10 -static_datasets_state_abv)

response =athena_client.start_query_execution(
    QueryString="SELECT * FROM static_datasets_state_abv",
    QueryExecutionContext={"Database":SCHEMA_NAME},
    ResultConfiguration={
        "OutputLocation":S3_STAGING_DIR,
        "EncryptionConfiguration":{"EncryptionOption":"SSE_S3"},
    },
)


static_datasets_state_abv=download_and_load_query_results(athena_client,response)

static_datasets_state_abv.head()




